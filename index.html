<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <link rel="stylesheet" href="./styles/styles.css" />
  <title>Positivus</title>
  <style>
    /* Скрываем тело страницы по умолчанию */
    body {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
      /* Плавное появление */
    }

    /* Показываем тело страницы, когда проверка завершена */
    body.visible {
      visibility: visible;
      opacity: 1;
    }
  </style>

  <script>
    /**
     * Управление токеном в localStorage
     */
    function setAuthToken(token) {
      localStorage.setItem('auth_jwt', token);
    }

    function getAuthToken() {
      return localStorage.getItem('auth_jwt');
    }

    function removeAuthToken() {
      localStorage.removeItem('auth_jwt');
    }

    function decodeToken(token) {
      try {
        const payload = JSON.parse(atob(token.split('.')[1])); // Раскодируем payload из JWT
        return payload;
      } catch (error) {
        console.error('Ошибка расшифровки токена:', error);
        return null;
      }
    }

    function isAuthenticated() {
      const token = getAuthToken();
      if (!token) return false;

      const decoded = decodeToken(token);
      if (!decoded) return false;

      const currentTime = Date.now() / 1000;
      return decoded.exp && decoded.exp > currentTime;
    }

    /**
     * Функция ожидания получения токена через postMessage
     * @param {number} timeout - Максимальное время ожидания в миллисекундах
     * @returns {Promise<string>} - Возвращает токен или отклоняет промис
     */
    function waitForToken(timeout = 5000) {
      return new Promise((resolve, reject) => {
        let tokenReceived = false;

        // Обработчик сообщений postMessage
        function messageHandler(event) {
          const allowedOrigins = ['http://localhost:3000', 'http://127.0.0.1:5500']; // Добавьте ваши доверенные источники

          if (!allowedOrigins.includes(event.origin)) {
            console.warn('Получено сообщение от недоверенного источника:', event.origin);
            return;
          }

          const { token } = event.data;

          if (token) {
            setAuthToken(token);
            console.log('Токен успешно получен и сохранен:', token);
            tokenReceived = true;
            cleanup();
            resolve(token); // Завершаем ожидание
          }
        }

        // Добавляем обработчик сообщений
        window.addEventListener('message', messageHandler);

        // Таймер на случай, если токен не будет получен
        const timer = setTimeout(() => {
          if (!tokenReceived) {
            console.warn('Токен не получен в течение заданного времени');
            cleanup();
            reject('Токен не получен в течение заданного времени');
          }
        }, timeout);

        // Функция очистки обработчиков и таймеров
        function cleanup() {
          window.removeEventListener('message', messageHandler);
          clearTimeout(timer);
        }
      });
    }

    /**
     * Основная функция проверки и отображения страницы
     */
    async function checkAndShowPage() {
      try {
        let token = getAuthToken();

        if (!token) {
          console.log('Токен не найден в LocalStorage. Ожидание получения токена через postMessage...');
          // Ожидаем получения токена через postMessage
          try {
            token = await waitForToken(5000); // Ожидание до 5 секунд
          } catch (error) {
            console.error(error);
            window.location.href = '/login'; // Перенаправляем на страницу входа
            return;
          }
        } else {
          console.log('Токен найден в LocalStorage:', token);
        }

        // Расшифровываем токен
        const decodedToken = decodeToken(token);

        if (!decodedToken || !decodedToken.id) {
          console.warn('Некорректный токен. Перенаправляем на страницу входа.');
          window.location.href = '/login';
          return;
        }

        console.log('Расшифрованный токен:', decodedToken);

        // Проверяем данные пользователя через API
        const response = await fetch(`http://localhost:1337/api/ssos/me`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`, // Передаём токен в заголовке
            'Content-Type': 'application/json',
          },
        });

        if (response.ok) {
          const { user, newToken } = await response.json();
          console.log('Ответ SSO API:', user);

          // Перезаписываем токен, если сервер вернул новый
          if (newToken) {
            console.log('Получен новый токен. Обновляем в LocalStorage:', newToken);
            setAuthToken(newToken);
          }

          // Проверяем роль пользователя
          if (user.id === decodedToken.id && user.user_roles.some(role => role.name === 'glav-bobr')) {
            document.body.classList.add('visible'); // Показываем страницу
          } else {
            console.warn('У пользователя нет необходимой роли. Перенаправляем.');
            window.location.href = '/no-access'; // Перенаправляем на страницу ошибки
          }
        } else {
          console.warn('Ошибка получения данных пользователя через API. Перенаправляем.');
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Ошибка проверки токена или данных пользователя:', error);
        window.location.href = '/login';
      }
    }

    /**
     * Обработка изменений в localStorage для синхронизации токена между вкладками
     */
    window.addEventListener('storage', (event) => {
      if (event.key === 'auth_jwt') {
        console.log('auth_jwt изменен в другой вкладке:', event.newValue);
        if (!event.newValue) {
          // Токен был удален, перенаправляем на страницу входа
          window.location.href = '/login';
        } else {
          // Токен был обновлен, проверяем его валидность
          checkAndShowPage();
        }
      }
    });

    /**
     * Обработка новых токенов через postMessage
     */
    window.addEventListener('message', (event) => {
      const allowedOrigins = ['http://localhost:3000', 'http://127.0.0.1:5500'];
      if (!allowedOrigins.includes(event.origin)) {
        console.warn('Получено сообщение от недоверенного источника:', event.origin);
        return;
      }

      const { token } = event.data;
      if (token) {
        setAuthToken(token);
        console.log('Получен новый токен через postMessage:', token);
        checkAndShowPage();
      }
    });

    /**
     * Запуск проверки при загрузке страницы
     */
    window.addEventListener('DOMContentLoaded', checkAndShowPage);
  </script>

</head>

<body>
  <header class="header">
    <div class="header__inner container">
      <a class="header__logo logo" href="/">
        <img src="./images/logo.svg" alt="Positivus" width="220" height="36" loading="lazy" />
      </a>
      <nav class="header__menu hidden-mobile">
        <ul class="header__menu-list">
          <li class="header__menu-item">
            <a class="header__menu-link" href="/">About us</a>
          </li>
          <li class="header__menu-item">
            <a class="header__menu-link" href="/">Services</a>
          </li>
          <li class="header__menu-item">
            <a class="header__menu-link" href="/">Use Cases</a>
          </li>
          <li class="header__menu-item">
            <a class="header__menu-link" href="/">Pricing</a>
          </li>
          <li class="header__menu-item">
            <a class="header__menu-link" href="/">Blog</a>
          </li>
        </ul>
      </nav>
      <button class="header__button button button--transparent hidden-mobile" type="button">
        Request a quote
      </button>
      <button class="button__burger-menu burger-button visible-mobile" type="button"
              onclick="mobileOverlay.showModal()">
        <span class="visually-hidden">Open navigation menu</span>
      </button>
    </div>
  </header>
</body>

</html>